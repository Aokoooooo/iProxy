<script>
  ;(function() {
    var config = window.whistleInspectorConfig;
    var activeList = [];
    var stateList = [1];
    var getActiveSession;
    var getSelectedSessionList;
    var listenersList = [];

    function initState(flag) {
      stateList[1] = flag;
      stateList[2] = flag;
      stateList[3] = flag;
    }

    function updateState(item) {
      if (!item || item.lost || item.endTime) {
        return  initState(1);
      }
      initState();
      if (item.responseTime) {
        stateList[2] = 1;
      }
      if (item.requestTime) {
        stateList[1] = 1;
      }
    }

    function emitListeners(item, state) {
      if (stateList[state] && item !== activeList[state]) {
        activeList[state] = item;
        var listeners = listenersList[state];
        listeners.forEach(function(l) {
          l(item);
        });
      }
    }

    function emitAll(item) {
      updateState(item);
      emitListeners(item, 0);
      emitListeners(item, 1);
      emitListeners(item, 2);
      emitListeners(item, 3);
    }

    window.__pushWhistle5b6af7b9884e1165SessionActive__ = emitAll;

    function getAddEventHandler(state) {
      state = state || 0;
      listenersList[state] = [];
      return function(l) {
        if (typeof l !== 'function') {
          return;
        }
        var item = getActiveSession();
        emitAll(item);
        activeList[state] = item;
        if (stateList[state]) {
          l(item);
        }
        var listeners = listenersList[state];
        listeners.indexOf(l) === -1 && listeners.push(l);
      };
    }

    function getRemoveEventListener(state) {
      state = state || 0;
      return function(l) {
        var listeners = listenersList[state];
        var index = listeners.indexOf(l);
        index !== -1 && listeners.splice(index, 1);
      };
    }

    function getRemoveEventListeners(state) {
      state = state || 0;
      return function(l) {
        listenersList[state] = [];
      };
    }

    var toast = {};
    var whistleBridge = {
      config: config,
      toast: toast,
      addSessionActiveListener: getAddEventHandler(),
      removeSessionActiveListener: getRemoveEventListener(),
      removeSessionActiveListeners: getRemoveEventListeners(),
      addSessionRequestListener: getAddEventHandler(1),
      removeSessionRequestListener: getRemoveEventListener(1),
      removeSessionRequestListeners: getRemoveEventListeners(1),
      addSessionResponseListener: getAddEventHandler(2),
      removeSessionResponseListener: getRemoveEventListener(2),
      removeSessionResponseListeners: getRemoveEventListeners(2),
      addSessionCompleteListener: getAddEventHandler(3),
      removeSessionCompleteListener: getRemoveEventListener(3),
      removeSessionCompleteListeners: getRemoveEventListeners(3)
    };

    try {
      window.parent.onWhistleInspectorCustomTabReady(function(options) {
        Object.keys(options.msgBox).forEach(function(name) {
          toast[name] = options.msgBox[name];
        });
        getActiveSession = options.getActiveSession;
        getSelectedSessionList = options.getSelectedSessionList;
        whistleBridge.decodeBase64 = options.decodeBase64;
        whistleBridge.importSessions = options.importSessions;
        whistleBridge.request = options.request;
        whistleBridge.createRequest = options.createRequest;
        whistleBridge.showModal = options.showModal;
        whistleBridge.getSelectedSessionList = getSelectedSessionList;
        whistleBridge.getActiveSession = whistleBridge.getSession = whistleBridge.getSelectedSession = getActiveSession;
        whistleBridge.importRules = options.importRules;
        whistleBridge.importValues = options.importValues;
        whistleBridge.getServerInfo = options.getServerInfo;
        whistleBridge.alert = options.alert;
        whistleBridge.confirm = options.confirm;
      });
    } catch (e) {}
    window.whistleBridge = whistleBridge;
  })();
</script>
